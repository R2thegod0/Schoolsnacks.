<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSA Snacks Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 5. CONFETTI SCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* --- DESIGN SYSTEM (Neon Cyberpunk) --- */
        :root {
            --bg: #050505;
            --surface: #121212;
            --primary: #00ff9d; /* Matrix Green */
            --accent: #d600ff;  /* Cyber Pink */
            --text: #ffffff;
            --border: #333;
        }

        /* 4. LIGHT MODE VARIABLES */
        [data-theme="light"] {
            --bg: #f4f4f9;
            --surface: #ffffff;
            --primary: #00bf72;
            --accent: #b000d3;
            --text: #1a1a1a;
            --border: #ddd;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; transition: 0.3s; }
        
        nav { background: var(--surface); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; }
        
        /* 3. SEARCH BAR */
        .search-container { padding: 10px 20px; max-width: 600px; margin: 0 auto; }
        .search-input { width: 100%; padding: 12px 20px; border-radius: 30px; border: 1px solid var(--border); background: var(--surface); color: var(--text); outline: none; transition: 0.3s; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 255, 157, 0.2); }

        /* Filters */
        .filters { display: flex; justify-content: center; gap: 10px; padding: 10px; flex-wrap: wrap; }
        .filter-btn {
            background: var(--surface); border: 1px solid var(--border); color: var(--text); opacity: 0.7;
            padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: 0.3s; font-weight: bold;
        }
        .filter-btn.active, .filter-btn:hover {
            border-color: var(--primary); opacity: 1; background: var(--primary); color: #000;
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        
        .card { 
            background: var(--surface); border-radius: 12px; overflow: hidden; 
            border: 1px solid var(--border); display: flex; flex-direction: column;
            transition: 0.2s; position: relative;
        }
        
        /* 1. SOLD OUT STYLE */
        .card.sold-out { opacity: 0.6; pointer-events: none; }
        .card.sold-out::after { content: "SOLD OUT"; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background: #ff0000; color: white; padding: 5px 15px; font-weight: bold; border: 2px solid white; z-index: 10; }

        /* 16. TRENDING TAG */
        .trending-tag { position: absolute; top: 10px; left: 10px; background: #ffaa00; color: black; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        /* 7. FAVORITE HEART */
        .fav-btn { position: absolute; top: 10px; right: 10px; color: white; background: rgba(0,0,0,0.5); border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 5; transition: 0.2s; }
        .fav-btn.active { color: #ff2a6d; background: white; }

        .card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .card img { width: 100%; height: 140px; object-fit: cover; }
        .card-body { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        
        .title-row { display: flex; justify-content: space-between; align-items: start; }
        .price { color: var(--accent); font-weight: bold; font-size: 1.1rem; }
        
        /* 2. VEG/SPICY ICONS */
        .icon-badge { font-size: 0.8rem; margin-left: 5px; }
        .veg { color: #00ff00; } .non-veg { color: #ff4444; } .spicy { color: #ff6b6b; }

        .add-btn { 
            background: var(--surface); color: var(--text); border: 1px solid var(--border); 
            padding: 8px; width: 100%; border-radius: 6px; cursor: pointer; margin-top: 10px;
        }
        .add-btn:hover { background: var(--accent); border-color: var(--accent); color: white; }

        /* Floating Checkout */
        .floating-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(90deg, var(--primary), #00ccff); color: #000;
            padding: 15px 30px; border-radius: 30px;
            font-weight: bold; box-shadow: 0 0 20px rgba(0, 255, 157, 0.4);
            cursor: pointer; z-index: 99; display: none; width: 80%; max-width: 300px; text-align: center;
        }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; backdrop-filter: blur(5px); }
        .modal-content { 
            background: var(--surface); width: 90%; max-width: 400px; margin: 50px auto; 
            padding: 25px; border-radius: 15px; border: 1px solid var(--border); position: relative; color: var(--text);
        }
        input, textarea, select { 
            width: 100%; padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.1); 
            border: 1px solid var(--border); color: var(--text); border-radius: 6px; box-sizing: border-box; 
        }
        input:focus { outline: none; border-color: var(--primary); }

        /* Admin Styles */
        .admin-stat { display: inline-block; background: #222; padding: 5px 10px; border-radius: 5px; color: var(--primary); font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">SSA SNACKS</div>
        <div style="display: flex; gap: 20px; align-items: center;">
            <!-- 4. THEME TOGGLE -->
            <i class="fas fa-sun" id="themeToggle" onclick="toggleTheme()" style="cursor: pointer; color: var(--text);"></i>
            
            <div onclick="openCart()" style="position: relative; cursor: pointer;">
                <i class="fas fa-shopping-cart" style="font-size: 1.2rem; color: var(--text);"></i>
                <span id="cartCount" style="position: absolute; top: -8px; right: -8px; background: var(--accent); color: white; font-size: 0.7rem; padding: 2px 5px; border-radius: 50%;">0</span>
            </div>
        </div>
    </nav>

    <!-- 3. SEARCH -->
    <div class="search-container">
        <input type="text" class="search-input" placeholder="Search for chips, drinks..." onkeyup="handleSearch(this.value)">
    </div>

    <!-- FILTERS (Including 9. Combos, 7. Favorites) -->
    <div class="filters">
        <button class="filter-btn active" onclick="filterItems('all', this)">All</button>
        <button class="filter-btn" onclick="filterItems('eat', this)">üçü Eat</button>
        <button class="filter-btn" onclick="filterItems('drink', this)">ü•§ Drink</button>
        <button class="filter-btn" onclick="filterItems('combo', this)">üç± Combos</button>
        <button class="filter-btn" onclick="filterItems('fav', this)">‚ù§Ô∏è Favorites</button>
    </div>

    <div class="container">
        <div class="grid" id="productGrid"></div>
    </div>

    <div class="floating-bar" id="floatBar" onclick="openCart()">
        View Cart ‚Ä¢ ‚Çπ<span id="floatTotal">0</span>
    </div>

    <!-- CHECKOUT MODAL -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span onclick="closeCart()" style="position:absolute; right:20px; top:15px; font-size:1.5rem; cursor:pointer;">&times;</span>
            <h2>Checkout</h2>
            <div id="cartList" style="margin-bottom:20px;"></div>
            
            <h3 style="color: var(--primary);">Delivery Details</h3>
            <!-- 6. REMEMBER ME (Auto-fill) -->
            <input type="text" id="cName" placeholder="Name & Class (e.g. Rahul 12-A)">
            <input type="text" id="cLoc" placeholder="Location (e.g. Library Entrance)">
            <input type="number" id="cDist" placeholder="Distance (km)" step="0.1">
            
            <!-- 8. INSTRUCTIONS -->
            <textarea id="cNote" placeholder="Extra Instructions (Optional)" rows="2"></textarea>
            
            <!-- 17. REFERRAL CODE -->
            <input type="text" id="cRef" placeholder="Referral Code (Optional)">

            <button onclick="placeOrder()" style="width:100%; background:var(--primary); border:none; padding:15px; font-weight:bold; cursor:pointer; margin-top:10px; color: #000;">CONFIRM (COD)</button>
        </div>
    </div>

    <!-- 20. FEEDBACK MODAL -->
    <div id="feedbackModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h2 style="color: var(--primary);">Order Placed! üéâ</h2>
            <p>Please rate your experience:</p>
            <div style="font-size: 2rem; margin: 20px 0;">
                <span onclick="closeFeedback()" style="cursor:pointer;">üò°</span>
                <span onclick="closeFeedback()" style="cursor:pointer;">üòê</span>
                <span onclick="closeFeedback()" style="cursor:pointer;">üôÇ</span>
                <span onclick="closeFeedback()" style="cursor:pointer;">üòç</span>
            </div>
            <button onclick="closeFeedback()" style="background: #333; color: white; padding: 10px 20px; border: none; border-radius: 5px;">Close</button>
        </div>
    </div>

    <!-- ADMIN MODAL -->
    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <span onclick="closeAdmin()" style="float:right; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h2>üì¶ Live Dashboard</h2>
            
            <!-- 13. DAILY REVENUE -->
            <div class="admin-stat">Today's Sales: ‚Çπ<span id="dailyRev">0</span></div>

            <div id="adminList" style="max-height:60vh; overflow-y:auto;">Loading...</div>
        </div>
    </div>

    <div style="text-align:center; padding:20px; opacity:0.3;">
        <span onclick="openAdmin()" style="cursor:pointer;">Staff Access</span>
    </div>

    <audio id="dingSound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3"></audio>

    <script type="module">
        // --- FIREBASE SETUP ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc } 
        from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // *** YOUR CONFIG ***
        const firebaseConfig = {
            apiKey: "AIzaSyCw7hPKmKEK0foI2HxZGUuMcp5UMu5RaDs",
            authDomain: "schoolsnacks-44e3a.firebaseapp.com",
            projectId: "schoolsnacks-44e3a",
            storageBucket: "schoolsnacks-44e3a.firebasestorage.app",
            messagingSenderId: "305869556514",
            appId: "1:305869556514:web:e043c76d7da810ddc4b37b",
            measurementId: "G-BYFMCJSPX2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DATA (Enhanced with Stock, Trending, Veg/Spicy) ---
        const products = [
            { id: 1, name: "Spicy Lays", price: 20, cat: "eat", stock: 15, isVeg: true, isSpicy: true, trending: true, img: "https://images.unsplash.com/photo-1566478919030-261443943938?auto=format&fit=crop&w=300&q=80" },
            { id: 2, name: "Coke Can", price: 40, cat: "drink", stock: 20, isVeg: true, isSpicy: false, trending: false, img: "https://images.unsplash.com/photo-1622483767028-3f66f32aef97?auto=format&fit=crop&w=300&q=80" },
            { id: 3, name: "Chicken Sub", price: 80, cat: "eat", stock: 5, isVeg: false, isSpicy: false, trending: true, img: "https://images.unsplash.com/photo-1509722747741-092071b55fea?auto=format&fit=crop&w=300&q=80" },
            { id: 4, name: "Cold Coffee", price: 50, cat: "drink", stock: 10, isVeg: true, isSpicy: false, trending: false, img: "https://images.unsplash.com/photo-1461023058943-07fcbe16d735?auto=format&fit=crop&w=300&q=80" },
            { id: 5, name: "Combo Meal", price: 90, cat: "combo", stock: 8, isVeg: false, isSpicy: true, trending: false, img: "https://images.unsplash.com/photo-1594212699903-ec8a3eca50f5?auto=format&fit=crop&w=300&q=80" },
            { id: 6, name: "Chocolate", price: 20, cat: "eat", stock: 0, isVeg: true, isSpicy: false, trending: false, img: "https://images.unsplash.com/photo-1511381939415-e44015466834?auto=format&fit=crop&w=300&q=80" },
        ];

        let cart = [];
        let favorites = JSON.parse(localStorage.getItem('favs')) || [];
        let currentFilter = 'all';

        // --- 4. THEME TOGGLE LOGIC ---
        window.toggleTheme = () => {
            const body = document.body;
            const icon = document.getElementById('themeToggle');
            if (body.getAttribute('data-theme') === 'light') {
                body.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
            } else {
                body.setAttribute('data-theme', 'light');
                icon.className = 'fas fa-moon';
            }
        };

        // --- RENDER & FILTER ---
        window.handleSearch = (txt) => {
            renderGrid(currentFilter, txt.toLowerCase());
        };

        window.filterItems = (cat, btn) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = cat;
            renderGrid(cat, document.querySelector('.search-input').value.toLowerCase());
        };

        function renderGrid(cat, searchTxt) {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = "";
            
            let filtered = products;

            // Filter Category
            if (cat === 'fav') filtered = products.filter(p => favorites.includes(p.id));
            else if (cat !== 'all') filtered = products.filter(p => p.cat === cat);

            // Filter Search
            if (searchTxt) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTxt));

            filtered.forEach(p => {
                const isFav = favorites.includes(p.id) ? 'active' : '';
                const soldOutClass = p.stock === 0 ? 'sold-out' : '';
                const trendingHtml = p.trending ? '<div class="trending-tag">üî• HOT</div>' : '';
                const vegIcon = p.isVeg ? '<i class="fas fa-circle icon-badge veg" title="Veg"></i>' : '<i class="fas fa-circle icon-badge non-veg" title="Non-Veg"></i>';
                const spicyIcon = p.isSpicy ? '<i class="fas fa-pepper-hot icon-badge spicy" title="Spicy"></i>' : '';

                grid.innerHTML += `
                    <div class="card ${soldOutClass}">
                        ${trendingHtml}
                        <div class="fav-btn ${isFav}" onclick="toggleFav(${p.id}, this)"><i class="fas fa-heart"></i></div>
                        <img src="${p.img}">
                        <div class="card-body">
                            <div class="title-row">
                                <h3>${p.name}</h3>
                                <div>${vegIcon}${spicyIcon}</div>
                            </div>
                            <div class="price">‚Çπ${p.price}</div>
                            <button class="add-btn" onclick="window.addToCart(${p.id})">
                                ${p.stock === 0 ? "SOLD OUT" : "ADD"}
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        // Initial Render
        renderGrid('all', '');

        // --- 7. FAVORITES LOGIC ---
        window.toggleFav = (id, btn) => {
            if (favorites.includes(id)) {
                favorites = favorites.filter(fid => fid !== id);
                btn.classList.remove('active');
            } else {
                favorites.push(id);
                btn.classList.add('active');
            }
            localStorage.setItem('favs', JSON.stringify(favorites));
        };

        // --- CART & ORDER ---
        window.addToCart = (id) => {
            cart.push(products.find(p => p.id === id));
            updateUI();
        };

        function updateUI() {
            document.getElementById('cartCount').innerText = cart.length;
            const total = cart.reduce((a, b) => a + b.price, 0);
            document.getElementById('floatTotal').innerText = total;
            document.getElementById('floatBar').style.display = cart.length ? 'block' : 'none';
            
            const list = document.getElementById('cartList');
            list.innerHTML = cart.map((i, idx) => 
                `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #333;">
                    <span>${i.name}</span>
                    <span>‚Çπ${i.price} <i class="fas fa-trash" onclick="cart.splice(${idx},1); updateUI()" style="color:red; cursor:pointer;"></i></span>
                </div>`
            ).join('');
        }

        window.openCart = () => {
            document.getElementById('cartModal').style.display = 'block';
            // 6. AUTO FILL NAME/CLASS
            if(localStorage.getItem('userName')) document.getElementById('cName').value = localStorage.getItem('userName');
        }
        window.closeCart = () => document.getElementById('cartModal').style.display = 'none';

        window.placeOrder = async () => {
            const name = document.getElementById('cName').value;
            const loc = document.getElementById('cLoc').value;
            const dist = parseFloat(document.getElementById('cDist').value);
            const note = document.getElementById('cNote').value;
            
            if(!name || !loc || !dist) return alert("Fill all fields!");
            if(dist > 2.0) return alert("Distance must be < 2km");

            // SAVE NAME
            localStorage.setItem('userName', name);

            try {
                await addDoc(collection(db, "orders"), {
                    customer: name, location: loc, distance: dist, note: note,
                    items: cart.map(i => i.name), total: cart.reduce((a,b)=>a+b.price, 0),
                    status: 'Pending', assignedTo: 'Unassigned', timestamp: new Date()
                });
                
                // 5. CONFETTI ANIMATION
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                
                cart = []; updateUI(); closeCart();
                document.getElementById('feedbackModal').style.display = 'block'; // 20. Feedback
            } catch(e) { alert("Error: " + e.message); }
        };

        window.closeFeedback = () => document.getElementById('feedbackModal').style.display = 'none';

        // --- ADMIN PANEL ---
        window.openAdmin = () => {
            if(prompt("Password?") === "hyper123") {
                document.getElementById('adminModal').style.display = 'block';
                const audio = document.getElementById('dingSound');
                audio.play().then(() => audio.pause()).catch(()=>{});
                loadOrders();
            }
        };
        window.closeAdmin = () => document.getElementById('adminModal').style.display = 'none';

        // 15. DELIVERY BOY ASSIGNMENT
        window.assignOrder = async (id, name) => {
            await updateDoc(doc(db, "orders", id), { assignedTo: name });
        }

        function loadOrders() {
            const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('adminList');
                list.innerHTML = "";
                let dailyTotal = 0;
                const today = new Date().toDateString();

                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") document.getElementById('dingSound').play().catch(()=>{});
                });

                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    const dateObj = d.timestamp.toDate();
                    
                    // 13. CALCULATE REVENUE (If today)
                    if(dateObj.toDateString() === today && d.status !== 'Cancelled') dailyTotal += d.total;

                    // 11. TIME ELAPSED
                    const minsAgo = Math.floor((new Date() - dateObj) / 60000);
                    
                    if(d.status !== 'Delivered') {
                        list.innerHTML += `
                            <div style="background:#222; padding:15px; margin-bottom:10px; border-left:4px solid var(--primary); color:white;">
                                <div style="display:flex; justify-content:space-between;">
                                    <strong>${d.customer}</strong>
                                    <span style="color:var(--primary)">‚Çπ${d.total}</span>
                                </div>
                                <div style="font-size:0.8rem; color:#aaa; margin:5px 0;">
                                    üìç ${d.location} (${d.distance}km)<br>
                                    üìù ${d.note || "No notes"}<br>
                                    üõçÔ∏è ${d.items.join(', ')}<br>
                                    <span style="color:#ff4444;">‚è∞ ${minsAgo} mins ago</span>
                                </div>
                                <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                                    <select onchange="window.assignOrder('${docSnap.id}', this.value)" style="width:auto; padding:5px; margin:0; background:#333; color:white;">
                                        <option value="Unassigned" ${d.assignedTo === 'Unassigned' ? 'selected' : ''}>Assign...</option>
                                        <option value="Rahul" ${d.assignedTo === 'Rahul' ? 'selected' : ''}>Rahul</option>
                                        <option value="Amit" ${d.assignedTo === 'Amit' ? 'selected' : ''}>Amit</option>
                                    </select>
                                    <button onclick="markDone('${docSnap.id}')" style="background:var(--accent); border:none; color:white; padding:5px 10px; border-radius:4px;">Done</button>
                                </div>
                            </div>
                        `;
                    }
                });
                document.getElementById('dailyRev').innerText = dailyTotal;
            });
        }

        window.markDone = async (id) => {
            if(confirm("Delivered?")) await updateDoc(doc(db, "orders", id), { status: 'Delivered' });
        }
    </script>
</body>
</html>